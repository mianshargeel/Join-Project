<div class="overlay" (click)="onClose()"></div>
<div class="dialog" (click)="$event.stopPropagation()">
  @if (!editMode) {
  <!-- Full task view layout goes here -->
  <div class="dialog-header">
    <span class="task-category" [ngClass]="categoryClass(task.category)">
      {{ task.category }}
    </span>
    <button class="close-btn" (click)="onClose()">√ó</button>
  </div>
  <div class="dialog-body">
    <h1 class="task-title">{{ task.title }}</h1>
    <p class="task-description">{{ task.description }}</p>
    <div class="date-prio-section">
      <span class="section-label">Due date:</span>
      <span class="task-value">
        {{ task.duedate.toDate() | date: 'dd/MM/yyyy' }}
      </span>
    </div>
    <div class="date-prio-section">
      <span class="section-label">Priority:</span>
      <span class="priority-display">
        <span class="task-value">{{task.priority}}</span>
        <span class="priority-icon {{task.priority.toLowerCase()}}"></span>
      </span>
    </div>
    <div class="assignees-section">
      <span class="section-label">Assigned to:</span>
      <div class="assignees-list">
        @for (assignee of assignees; track assignee.id) {
        <div class="assignee">
          <span class="avatar" [style.backgroundColor]="assignee.color">{{ assignee.initials }}</span>
          <span class="name">{{ assignee.name }}</span>
        </div>
        }
      </div>
    </div>
    <div class="subtasks-section">
      <span class="section-label">Subtasks:</span>
      <div class="subtasks-list">
        @for (sub of task.subtasks; track sub.id) {
        <label class="subtask">
          <input type="checkbox" [(ngModel)]="sub.isdone" [ngModelOptions]="{ standalone: true }"
            (change)="onSubtaskToggle(sub)">
          <span>{{ sub.title }}</span>
        </label>
        }
      </div>
    </div>
    <div class="dialog-footer">
      <button class="action edit" (click)="enableEditMode()">
        <img src="/assets/img/board/edit.svg" width="18" height="18" alt="">Edit
      </button>
      <span class="vert-divider"></span>
      <button class="action delete" (click)="onDelete()">
        <img src="/assets/img/board/delete.svg" width="18" height="18" alt="">Delete
      </button>
    </div>
  </div>

  }
  @else {
  <!-- Full edit form layout goes here -->

  <div class="dialog-header">
    <span class="task-category" [ngClass]="categoryClass(task.category)">
      {{ task.category }}
    </span>
    <button class="close-btn" (click)="onClose()">√ó</button>
  </div>

  <div class="dialog-body">
    <form class="edit-dialog" (ngSubmit)="submitEdit()" #editForm="ngForm">
      <div class="form-group">
        <label>Title</label>
        <input type="text" [(ngModel)]="editableTask.title" name="title" required />
      </div>

      <div class="form-group">
        <label>Description</label>
        <textarea [(ngModel)]="editableTask.description" name="description"></textarea>
      </div>

      <div class="form-group">
        <label>Due Date</label>
        <input type="date" [(ngModel)]="editableTask.duedate" name="dueDate" />
      </div>

      <div class="form-group">
        <label>Priority</label>
        <div class="priority-buttons">
          <button type="button" (click)="setPriority('urgent')" [class.active]="editableTask.priority === 'urgent'">
            Urgent
            <img class="prio-icon" src="assets/img/board/urgent.svg" alt="Urgent Priority">
          </button>

          <button type="button" (click)="setPriority('medium')" [class.active]="editableTask.priority === 'medium'">
            Medium
            <img class="prio-icon" src="assets/img/board/medium.svg" alt="Medium Priority">
          </button>

          <button type="button" (click)="setPriority('low')" [class.active]="editableTask.priority === 'low'">
            Low
            <img class="prio-icon" src="assets/img/board/low.svg" alt="Low Priority">
          </button>
        </div>
      </div>

      <div class="form-group">
        <label>Assigned to:</label>
        <div class="dropdown-field" (click)="toggleDropdown()">
          <input type="text" readonly placeholder="Select contacts to assign" />
        </div>

        @if (dropdownOpen) {
        <div class="dropdown-content">
          @for (contact of firebaseTaskService.contactList; track contact.id) {
          <div class="dropdown-item">
            <span class="avatar" [style.backgroundColor]="getAvatarColor(contact.id ?? '')">
              {{ generateInitials(contact.name) }}
            </span>
            <span class="contact-name">{{ contact.name }}</span>
            <input type="checkbox" [value]="contact.id" [checked]="editableTask.assignees.includes(contact.id ?? '')"
              (change)="onCheckboxChange($event)" />
          </div>
          }
        </div>
        }
        <div class="selected-assignees">
          @for (id of editableTask.assignees; track id) {
          <span class="avatar" [style.backgroundColor]="getAvatarColor(id)">
            {{ getContactInitials(id) }}
          </span>
          }
        </div>
      </div>

      <div>
        <label>Subtasks</label>

        <!-- Subtask input field -->
        <div style="position: relative; display: inline-block; width: 100%;">
          <input type="text" name="editedSubtaskInput" placeholder="Add new subtask" [(ngModel)]="editedSubtaskInput"
            [readonly]="!isTyping" (click)="enableTyping()" (keydown.enter)="confirmSubtask()"
            style="width: 100%; padding-right: 70px; box-sizing: border-box; padding: 16px;" />
          @if (!isTyping) {
          <span
            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 18px; color: purple;"
            (click)="enableTyping()">Ôºã</span>
          }
          @if (isTyping) {
          <span
            style="position: absolute; right: 40px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 16px;"
            (click)="cancelSubtask()">‚úï</span>
          <span
            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 16px;"
            (click)="confirmSubtask()">‚úî</span>
          }
        </div>

        <!-- Subtasks list -->
        @if (editableTask.subtasks.length > 0) {
        <ul style="margin-top: 10px; padding-left: 20px;">
          @for (sub of editableTask.subtasks; let i = $index; track sub.id) {
          <li
            style="list-style: none; position: relative; padding: 6px 40px 6px 6px; background: #f5f5f5; border-radius: 6px; margin-bottom: 6px;"
            (mouseenter)="hoveredSubtaskIndex = i" (mouseleave)="hoveredSubtaskIndex = -1">
            @if (subtaskEditIndex === i) {
            <!-- Editable subtask -->
            <div style="position: relative; display: flex; align-items: center;">
              <input name="editedSubtaskText" [(ngModel)]="editedSubtaskText" (keydown.enter)="saveEdit(i)"
                style="width: 100%; padding-right: 50px; padding-left: 10px; box-sizing: border-box; padding: 15px;" />
              <span (click)="deleteSubtask(i)"
                style="position: absolute; right: 30px; cursor: pointer; color: grey;">üóëÔ∏è</span>
              <span (click)="saveEdit(i)"
                style="position: absolute; right: 10px; cursor: pointer; color: purple;">‚úî</span>
            </div>
            } @else {
            ‚Ä¢ {{ sub.title }}
            @if (hoveredSubtaskIndex === i) {
            <div style="position: absolute; top: 6px; right: 6px; display: flex; gap: 6px;">
              <button (click)="startEdit(i)" style="border: none; background: transparent; cursor: pointer;">‚úèÔ∏è</button>
              <button (click)="deleteSubtask(i)"
                style="border: none; background: transparent; cursor: pointer;">üóëÔ∏è</button>
            </div>
            }
            }
          </li>
          }
        </ul>
        }
      </div>

      <div class="form-actions">
        <button type="button" (click)="disableEditMode()">Cancel</button>
        <button type="submit">Save Changes</button>
      </div>
    </form>
  </div>


  }

</div>